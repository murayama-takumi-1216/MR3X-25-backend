name: Backend CI CD

on:
  push:
    branches:
      - main
      - master

env:
  NODE_VERSION: 20

jobs:
  build-and-deploy:
    name: Build and deploy backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build backend
        run: npm run build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Deploy and restart on server
        run: |
          ssh -o StrictHostKeyChecking=no "${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}" << 'ENDSSH'
            set -e

            cd /var/www/html/vps/MR3X-25-backend

            echo 'Pulling latest backend code'
            git pull

            echo 'Installing dependencies'
            npm ci

            echo 'Building backend'
            npm run build

            echo 'Restarting backend with pm2'
            if pm2 list | grep -q mr3x-backend; then
              pm2 restart mr3x-backend
            else
              pm2 start dist/main.js --name mr3x-backend
            fi

            pm2 save

            echo 'Backend deployment completed'
            pm2 status mr3x-backend
          ENDSSH
