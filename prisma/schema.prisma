// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CEO // MR3X Platform Administrator
  ADMIN // MR3X Admin
  PLATFORM_MANAGER // MR3X Internal Manager (support, statistics, client assistance - NO agency operations)
  AGENCY_ADMIN // Agency Director/Supervisor-General (manages all managers)
  AGENCY_MANAGER // Real Estate Agency Manager (manages brokers, properties, contracts - INSIDE agency)
  BROKER // Broker/Agent (manages properties and owners)
  PROPRIETARIO // Property Owner (linked to agency)
  INDEPENDENT_OWNER // Independent Owner (without agency, full admin features)
  INQUILINO // Tenant/Renter
  BUILDING_MANAGER // Building/Condominium Manager
  LEGAL_AUDITOR // Legal/Auditor
  REPRESENTATIVE // Representative/Affiliate
  API_CLIENT // API Client/Integrator
}

enum PropertyStatus {
  DISPONIVEL
  ALUGADO
  MANUTENCAO
  VACANT
  RENTED
  MAINTENANCE
}

enum ContractStatus {
  ATIVO
  ENCERRADO
  PENDENTE
  ACTIVE
  TERMINATED
  PENDING
}

enum PaymentType {
  ALUGUEL
  CONDOMINIO
  IPTU
  OUTROS
  RENT
  CONDOMINIUM
  TAX
  OTHER
}

enum NotificationType {
  ON_TIME
  OVERDUE
}

model Agency {
  id            BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  name          String   @db.VarChar(255)
  cnpj          String   @unique @db.VarChar(20)
  email         String   @db.VarChar(191)
  phone         String?  @db.VarChar(30)
  address       String?  @db.VarChar(255)
  city          String?  @db.VarChar(100)
  state         String?  @db.VarChar(10)
  zipCode       String?  @map("zip_code") @db.VarChar(20)
  status        String   @default("ACTIVE") @db.VarChar(20)
  plan          String   @default("FREE") @db.VarChar(20)
  maxProperties Int?     @default(1) @map("max_properties") // FREE plan: 1 property for agencies
  maxUsers      Int?     @default(5) @map("max_users") // FREE plan: 5 users for agencies
  agencyFee     Float    @default(8.0) @map("agency_fee") // Percentage fee for this agency (0-100)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  // Plan enforcement tracking
  lastPlanChange        DateTime? @map("last_plan_change") @db.Timestamp(0)
  frozenPropertiesCount Int       @default(0) @map("frozen_properties_count")
  frozenUsersCount      Int       @default(0) @map("frozen_users_count")

  // API access control (disabled on FREE plan)
  apiEnabled            Boolean   @default(false) @map("api_enabled")
  apiKey                String?   @map("api_key") @db.VarChar(255)

  // Relations
  users         User[]
  properties    Property[]
  contracts     Contract[]
  payments      Payment[]
  notifications Notification[]
  invoices      Invoice[]

  @@map("agencies")
}

model User {
  id                      BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  email                   String    @unique @db.VarChar(191)
  password                String    @db.VarChar(255)
  plainPassword           String?   @map("plain_password") @db.VarChar(255)
  role                    UserRole
  plan                    String    @db.VarChar(20)
  emailVerified           Boolean   @default(false) @map("email_verified")
  ownerId                 BigInt?   @map("owner_id") @db.UnsignedBigInt
  companyId               BigInt?   @map("company_id") @db.UnsignedBigInt
  agencyId                BigInt?   @map("agency_id") @db.UnsignedBigInt
  brokerId                BigInt?   @map("broker_id") @db.UnsignedBigInt
  createdBy               BigInt?   @map("created_by") @db.UnsignedBigInt
  phone                   String?   @db.VarChar(30)
  document                String?   @db.VarChar(30)
  birthDate               DateTime? @map("birth_date") @db.Date
  name                    String?   @db.VarChar(50)
  address                 String?   @db.VarChar(90)
  cep                     String?   @db.VarChar(20)
  neighborhood            String?   @db.VarChar(100)
  number                  String?   @db.VarChar(20)
  city                    String?   @db.VarChar(100)
  state                   String?   @db.VarChar(10)
  userType                String?   @map("user_type") @db.VarChar(2)
  legalRepresentativeId   BigInt?   @unique @map("legal_representative_id") @db.UnsignedBigInt
  status                  String    @default("ACTIVE") @db.VarChar(20)
  lastLogin               DateTime? @map("last_login") @db.Timestamp(0)
  customPermissions       String?   @map("custom_permissions") @db.Text
  notificationPreferences String?   @map("notification_preferences") @db.Text
  refreshToken            String?   @map("refresh_token") @db.Text
  refreshTokenExpires     DateTime? @map("refresh_token_expires") @db.Timestamp(0)
  // Frozen status for plan limit enforcement
  isFrozen                Boolean   @default(false) @map("is_frozen")
  frozenAt                DateTime? @map("frozen_at") @db.Timestamp(0)
  frozenReason            String?   @map("frozen_reason") @db.VarChar(255)
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  owner               User?                @relation("UserOwner", fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants             User[]               @relation("UserOwner")
  company             Company?             @relation(fields: [companyId], references: [id])
  agency              Agency?              @relation(fields: [agencyId], references: [id])
  broker              User?                @relation("BrokerClients", fields: [brokerId], references: [id])
  clients             User[]               @relation("BrokerClients")
  creator             User?                @relation("UserCreator", fields: [createdBy], references: [id])
  createdUsers        User[]               @relation("UserCreator")
  legalRepresentative LegalRepresentative? @relation(fields: [legalRepresentativeId], references: [id])

  ownedProperties   Property[] @relation("PropertyOwner")
  tenantProperties  Property[] @relation("PropertyTenant")
  brokerProperties  Property[] @relation("PropertyBroker")
  createdProperties Property[] @relation("PropertyCreatedBy")

  contracts      Contract[] @relation("ContractTenant")
  ownerContracts Contract[] @relation("ContractOwner")

  payments  Payment[]
  transfers Transfer[]

  notificationsAsOwner  Notification[] @relation("NotificationOwner")
  notificationsAsTenant Notification[] @relation("NotificationTenant")

  sentMessages     Message[] @relation("MessageSender")
  receivedMessages Message[] @relation("MessageReceiver")

  chatsAsParticipant1 Chat[]       @relation("ChatParticipant1")
  chatsAsParticipant2 Chat[]       @relation("ChatParticipant2")
  activeChats         ActiveChat[]

  // Inspection relations
  inspectionsAsInspector   Inspection[] @relation("InspectionInspector")
  inspectionsAssigned      Inspection[] @relation("InspectionAssignedBy")
  inspectionsApproved      Inspection[] @relation("InspectionApprovedBy")
  inspectionsCreated       Inspection[] @relation("InspectionCreatedBy")

  // Agreement relations
  agreementsAsTenant       Agreement[] @relation("AgreementTenant")
  agreementsAsOwner        Agreement[] @relation("AgreementOwner")
  agreementsApproved       Agreement[] @relation("AgreementApprovedBy")
  agreementsCreated        Agreement[] @relation("AgreementCreatedBy")

  // Invoice relations
  invoicesAsTenant         Invoice[] @relation("InvoiceTenant")
  invoicesAsOwner          Invoice[] @relation("InvoiceOwner")
  invoicesCreated          Invoice[] @relation("InvoiceCreator")

  auditLogs AuditLog[]

  deletedContracts  Contract[] @relation("ContractDeletedBy")
  deletedProperties Property[] @relation("PropertyDeletedBy")

  refreshTokens  RefreshToken[]
  uploadedImages PropertyImage[] @relation("PropertyImageUploader")

  planModificationRequests PlanModificationRequest[] @relation("PlanModificationRequester")
  planModificationReviews  PlanModificationRequest[] @relation("PlanModificationReviewer")

  // Sales inbox relations
  sentSalesMessages     SalesMessage[]      @relation("SalesMessageSender")
  receivedSalesMessages SalesMessage[]      @relation("SalesMessageRecipient")
  salesMessageReplies   SalesMessageReply[] @relation("SalesMessageReplySender")
  salesNotifications    SalesNotification[] @relation("SalesNotificationUser")

  // Sales Rep CRM relations
  salesProspects        SalesProspect[]     @relation("SalesRepProspects")
  salesProposals        SalesProposal[]     @relation("SalesRepProposals")
  salesCommissions      SalesCommission[]   @relation("SalesRepCommissions")
  salesActivities       SalesActivity[]     @relation("SalesRepActivities")
  salesGoals            SalesGoal[]         @relation("SalesRepGoals")

  // Tenant Analysis relations
  tenantAnalysesRequested TenantAnalysis[]  @relation("TenantAnalysisRequestedBy")

  @@map("users")
}

/// Stores short-lived verification codes for email address ownership checks
model EmailVerification {
  id          BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  requestId   String    @unique @map("request_id") @db.VarChar(191)
  email       String    @db.VarChar(191)
  codeHash    String    @map("code_hash") @db.VarChar(191)
  purpose     String    @default("register") @db.VarChar(50)
  attempts    Int       @default(0)
  maxAttempts Int       @default(5) @map("max_attempts")
  expiresAt   DateTime  @map("expires_at") @db.Timestamp(0)
  usedAt      DateTime? @map("used_at") @db.Timestamp(0)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamp(0)

  @@index([email, purpose])
  @@map("email_verifications")
}

model LegalRepresentative {
  id    BigInt  @id @default(autoincrement()) @db.UnsignedBigInt
  name  String  @db.VarChar(255)
  cpf   String  @db.VarChar(20)
  phone String? @db.VarChar(30)
  email String? @db.VarChar(255)
  role  String? @db.VarChar(50)

  user User?

  @@map("legal_representative")
}

model RefreshToken {
  id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  token     String   @unique @db.VarChar(191)
  userId    BigInt   @map("user_id") @db.UnsignedBigInt
  expiresAt DateTime @map("expires_at") @db.Timestamp(0)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  isRevoked Boolean  @default(false) @map("is_revoked")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Property {
  id             BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  ownerId        BigInt?   @map("owner_id") @db.UnsignedBigInt
  agencyId       BigInt?   @map("agency_id") @db.UnsignedBigInt
  brokerId       BigInt?   @map("broker_id") @db.UnsignedBigInt
  createdBy      BigInt?   @map("created_by") @db.UnsignedBigInt
  address        String    @db.VarChar(255)
  monthlyRent    Decimal?  @map("monthly_rent") @db.Decimal(12, 2)
  status         String    @db.VarChar(50)
  tenantId       BigInt?   @map("tenant_id") @db.UnsignedBigInt
  neighborhood   String    @default("") @db.VarChar(255)
  city           String    @default("") @db.VarChar(255)
  cep            String    @default("") @db.VarChar(20)
  name           String?   @db.VarChar(255)
  nextDueDate    DateTime? @map("next_due_date") @db.Date
  dueDay         Int?      @map("due_day")
  stateNumber    String?   @map("state_number") @db.VarChar(50)
  agencyFee      Float?    @map("agency_fee") // Property-specific agency fee (overrides agency fee if set)
  deleted        Boolean   @default(false)
  deletedAt      DateTime? @map("deleted_at") @db.DateTime(0)
  deletedBy      BigInt?   @map("deleted_by") @db.UnsignedBigInt
  // Frozen status for plan limit enforcement
  isFrozen       Boolean   @default(false) @map("is_frozen")
  frozenAt       DateTime? @map("frozen_at") @db.Timestamp(0)
  frozenReason   String?   @map("frozen_reason") @db.VarChar(255)
  previousStatus String?   @map("previous_status") @db.VarChar(50) // Status before freezing
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  owner         User?   @relation("PropertyOwner", fields: [ownerId], references: [id])
  agency        Agency? @relation(fields: [agencyId], references: [id])
  broker        User?   @relation("PropertyBroker", fields: [brokerId], references: [id])
  tenant        User?   @relation("PropertyTenant", fields: [tenantId], references: [id])
  creator       User?   @relation("PropertyCreatedBy", fields: [createdBy], references: [id])
  deletedByUser User?   @relation("PropertyDeletedBy", fields: [deletedBy], references: [id])

  contracts     Contract[]
  documents     Document[]
  notifications Notification[]
  payments      Payment[]
  expenses      Expense[]
  inspections   Inspection[]
  images        PropertyImage[]
  agreements    Agreement[]
  invoices      Invoice[]

  @@map("properties")
}

model Contract {
  id              BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  propertyId      BigInt    @map("property_id") @db.UnsignedBigInt
  tenantId        BigInt    @map("tenant_id") @db.UnsignedBigInt
  ownerId         BigInt?   @map("owner_id") @db.UnsignedBigInt
  agencyId        BigInt?   @map("agency_id") @db.UnsignedBigInt
  startDate       DateTime  @map("start_date") @db.Date
  endDate         DateTime  @map("end_date") @db.Date
  lastPaymentDate DateTime? @map("last_payment_date") @db.Date
  monthlyRent     Decimal   @map("monthly_rent") @db.Decimal(12, 2)
  deposit         Decimal?  @map("deposit") @db.Decimal(12, 2)
  dueDay          Int?      @map("due_day")
  description     String?   @db.Text
  status          String    @db.VarChar(20)
  tenant          String?   @db.VarChar(50)
  pdfPath         String?   @map("pdf_path") @db.VarChar(255)
  creci           String?   @db.VarChar(50) // CRECI number (e.g., 123456/SP-F or 123456/SP-J)
  contractToken   String?   @unique @map("contract_token") @db.VarChar(100) // MR3X-CTR-2025-XXXXX format
  contractHash    String?   @map("contract_hash") @db.VarChar(255) // SHA-256 hash for verification
  templateId      String?   @map("template_id") @db.VarChar(100) // Template identifier
  templateType    String?   @map("template_type") @db.VarChar(10) // CTR, ACD, VST
  clientIP        String?   @map("client_ip") @db.VarChar(45) // IPv4 or IPv6 address
  userAgent       String?   @map("user_agent") @db.VarChar(500) // Browser/Client user agent
  // Signature fields
  tenantSignature     String?   @map("tenant_signature") @db.Text // Base64 signature image
  tenantSignedAt      DateTime? @map("tenant_signed_at") @db.Timestamp(0)
  tenantSignedIP      String?   @map("tenant_signed_ip") @db.VarChar(45)
  tenantSignedAgent   String?   @map("tenant_signed_agent") @db.VarChar(500)
  ownerSignature      String?   @map("owner_signature") @db.Text
  ownerSignedAt       DateTime? @map("owner_signed_at") @db.Timestamp(0)
  ownerSignedIP       String?   @map("owner_signed_ip") @db.VarChar(45)
  ownerSignedAgent    String?   @map("owner_signed_agent") @db.VarChar(500)
  agencySignature     String?   @map("agency_signature") @db.Text
  agencySignedAt      DateTime? @map("agency_signed_at") @db.Timestamp(0)
  agencySignedIP      String?   @map("agency_signed_ip") @db.VarChar(45)
  agencySignedAgent   String?   @map("agency_signed_agent") @db.VarChar(500)
  witnessSignature    String?   @map("witness_signature") @db.Text
  witnessSignedAt     DateTime? @map("witness_signed_at") @db.Timestamp(0)
  witnessName         String?   @map("witness_name") @db.VarChar(100)
  witnessDocument     String?   @map("witness_document") @db.VarChar(30)
  deleted         Boolean   @default(false)
  deletedAt       DateTime? @map("deleted_at") @db.DateTime(0)
  deletedBy       BigInt?   @map("deleted_by") @db.UnsignedBigInt
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  property      Property @relation(fields: [propertyId], references: [id])
  agency        Agency?  @relation(fields: [agencyId], references: [id])
  tenantUser    User     @relation("ContractTenant", fields: [tenantId], references: [id])
  ownerUser     User?    @relation("ContractOwner", fields: [ownerId], references: [id])
  deletedByUser User?    @relation("ContractDeletedBy", fields: [deletedBy], references: [id])

  payments Payment[]
  audits   ContractAudit[]
  invoices Invoice[]
  agreements Agreement[]

  @@map("contracts")
}

model ContractAudit {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  contractId  BigInt   @map("contract_id") @db.UnsignedBigInt
  action      String   @db.VarChar(50)
  performedBy BigInt   @map("performed_by") @db.UnsignedBigInt
  performedAt DateTime @default(now()) @map("performed_at") @db.Timestamp(0)
  details     String?  @db.Text

  // Relations
  contract Contract @relation(fields: [contractId], references: [id])

  @@map("contract_audit")
}

model Document {
  id         BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  propertyId BigInt   @map("property_id") @db.UnsignedBigInt
  tenantId   BigInt?  @map("tenant_id") @db.UnsignedBigInt
  name       String   @db.VarChar(255)
  url        String   @db.VarChar(255)
  uploadedAt DateTime @default(now()) @map("uploaded_at") @db.Timestamp(0)
  file       Bytes?   @db.Blob

  // Relations
  property Property @relation(fields: [propertyId], references: [id])

  @@map("documents")
}

model Payment {
  id            BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  valorPago     Decimal   @map("valor_pago") @db.Decimal(19, 2)
  dataPagamento DateTime  @map("data_pagamento") @db.Timestamp(0)
  contratoId    BigInt?   @map("contrato_id") @db.UnsignedBigInt
  propertyId    BigInt    @map("property_id") @db.UnsignedBigInt
  userId        BigInt    @map("user_id") @db.UnsignedBigInt
  agencyId      BigInt?   @map("agency_id") @db.UnsignedBigInt
  comprovante   Bytes?    @db.Blob
  tipo          String    @db.VarChar(20)
  description   String?   @db.VarChar(255)
  dueDate       DateTime? @map("due_date") @db.Date
  status        String?   @default("PENDING") @db.VarChar(20)
  paymentMethod String?   @map("payment_method") @db.VarChar(50)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  property Property  @relation(fields: [propertyId], references: [id])
  contract Contract? @relation(fields: [contratoId], references: [id])
  user     User      @relation(fields: [userId], references: [id])
  agency   Agency?   @relation(fields: [agencyId], references: [id])

  @@map("payments")
}

model Notification {
  id                BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  description       String    @db.VarChar(255)
  ownerId           BigInt    @map("owner_id") @db.UnsignedBigInt
  tenantId          BigInt    @map("tenant_id") @db.UnsignedBigInt
  propertyId        BigInt    @map("property_id") @db.UnsignedBigInt
  agencyId          BigInt?   @map("agency_id") @db.UnsignedBigInt
  recurring         String    @db.VarChar(50)
  type              String    @db.VarChar(20)
  days              Int
  creationDate      DateTime  @map("creation_date") @db.Timestamp(0)
  lastExecutionDate DateTime? @map("last_execution_date") @db.Timestamp(0)

  // Relations
  owner    User     @relation("NotificationOwner", fields: [ownerId], references: [id])
  tenant   User     @relation("NotificationTenant", fields: [tenantId], references: [id])
  property Property @relation(fields: [propertyId], references: [id])
  agency   Agency?  @relation(fields: [agencyId], references: [id])

  @@map("notifications")
}

model Chat {
  id             BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  name           String?   @db.VarChar(255)
  createdAt      DateTime? @map("created_at") @db.Timestamp(0)
  participant1Id BigInt    @map("participant1_id") @db.UnsignedBigInt
  participant2Id BigInt    @map("participant2_id") @db.UnsignedBigInt

  // Relations
  participant1 User @relation("ChatParticipant1", fields: [participant1Id], references: [id])
  participant2 User @relation("ChatParticipant2", fields: [participant2Id], references: [id])

  messages    Message[]
  activeChats ActiveChat[]

  @@map("chats")
}

model ActiveChat {
  chatId   BigInt @map("chat_id") @db.UnsignedBigInt
  userId   BigInt @map("user_id") @db.UnsignedBigInt
  chatName String @map("chat_name") @db.VarChar(100)
  unread   Int    @default(0)

  // Relations
  chat Chat @relation(fields: [chatId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@id([chatId, userId])
  @@map("active_chats")
}

model Message {
  id               BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  content          String?   @db.VarChar(1000)
  messageTimestamp DateTime? @map("message_timestamp") @db.Timestamp(0)
  messageRead      Boolean?  @map("message_read")
  senderId         BigInt?   @map("sender_id") @db.UnsignedBigInt
  receiverId       BigInt?   @map("receiver_id") @db.UnsignedBigInt
  chatId           BigInt?   @map("chat_id") @db.UnsignedBigInt

  // Relations
  sender   User? @relation("MessageSender", fields: [senderId], references: [id])
  receiver User? @relation("MessageReceiver", fields: [receiverId], references: [id])
  chat     Chat? @relation(fields: [chatId], references: [id])

  @@map("messages")
}

model IgpmIndex {
  id             BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  referenceMonth DateTime @unique @map("reference_month") @db.Date
  monthValue     Decimal  @map("month_value") @db.Decimal(10, 6)
  accumulated12m Decimal  @map("accumulated_12m") @db.Decimal(10, 6)
  createdAt      DateTime @map("created_at") @db.Timestamp(0)

  @@map("igpm_index")
}

// New models based on requirements
model Company {
  id              BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  name            String    @db.VarChar(255)
  cnpj            String    @unique @db.VarChar(20)
  address         String    @db.VarChar(255)
  responsible     String    @db.VarChar(255)
  contacts        String?   @db.Text
  plan            String    @default("FREE") @db.VarChar(20)
  propertyLimit   Int?      @map("property_limit")
  contractDate    DateTime? @map("contract_date") @db.Date
  nfseDocument    String?   @map("nfse_document") @db.VarChar(255)
  serviceContract String?   @map("service_contract") @db.VarChar(255)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  users User[]

  @@map("companies")
}

model Invoice {
  id            BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  contractId    BigInt   @map("contract_id") @db.UnsignedBigInt
  propertyId    BigInt?  @map("property_id") @db.UnsignedBigInt
  agencyId      BigInt?  @map("agency_id") @db.UnsignedBigInt
  tenantId      BigInt?  @map("tenant_id") @db.UnsignedBigInt
  ownerId       BigInt?  @map("owner_id") @db.UnsignedBigInt

  // Invoice identification
  invoiceNumber String?  @unique @map("invoice_number") @db.VarChar(50)
  referenceMonth String? @map("reference_month") @db.VarChar(7) // YYYY-MM format
  description   String?  @db.VarChar(500)
  type          String   @default("RENT") @db.VarChar(30) // RENT, CONDOMINIUM, EXTRA, FINE, PENALTY, OTHER

  // Financial values
  dueDate       DateTime @map("due_date") @db.Date
  originalValue Decimal  @map("original_value") @db.Decimal(12, 2)
  fine          Decimal? @db.Decimal(12, 2)
  interest      Decimal? @db.Decimal(12, 2)
  discount      Decimal? @db.Decimal(12, 2)
  updatedValue  Decimal  @map("updated_value") @db.Decimal(12, 2)
  paidValue     Decimal? @map("paid_value") @db.Decimal(12, 2)
  paidAt        DateTime? @map("paid_at") @db.Timestamp(0)

  // Status and payment info
  status        String   @default("PENDING") @db.VarChar(20) // PENDING, PAID, OVERDUE, CANCELED, REFUNDED
  paymentMethod String?  @map("payment_method") @db.VarChar(50) // PIX, BOLETO, CREDIT_CARD

  // Asaas integration
  asaasId       String?  @unique @map("asaas_id") @db.VarChar(100) // Asaas payment ID
  asaasCustomerId String? @map("asaas_customer_id") @db.VarChar(100)
  paymentLink   String?  @map("payment_link") @db.VarChar(500)
  boletoUrl     String?  @map("boleto_url") @db.VarChar(500)
  pixQrCode     String?  @map("pix_qr_code") @db.Text
  pixCopyPaste  String?  @map("pix_copy_paste") @db.Text
  barcode       String?  @db.VarChar(100)
  boletoDigitableLine String? @map("boleto_digitable_line") @db.VarChar(100)

  // Split information (for agency/owner distribution)
  ownerAmount   Decimal? @map("owner_amount") @db.Decimal(12, 2)
  agencyAmount  Decimal? @map("agency_amount") @db.Decimal(12, 2)
  platformFee   Decimal? @map("platform_fee") @db.Decimal(12, 2)
  gatewayFee    Decimal? @map("gateway_fee") @db.Decimal(12, 2)

  // Webhook and sync
  webhookStatus String?  @map("webhook_status") @db.VarChar(50)
  lastWebhookAt DateTime? @map("last_webhook_at") @db.Timestamp(0)
  syncedAt      DateTime? @map("synced_at") @db.Timestamp(0)

  // Email/notification tracking
  emailSentAt   DateTime? @map("email_sent_at") @db.Timestamp(0)
  reminderSentAt DateTime? @map("reminder_sent_at") @db.Timestamp(0)

  // Receipt
  receiptUrl    String?  @map("receipt_url") @db.VarChar(500)

  // Metadata
  notes         String?  @db.Text
  createdBy     BigInt?  @map("created_by") @db.UnsignedBigInt
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  // Relations
  contract  Contract   @relation(fields: [contractId], references: [id])
  property  Property?  @relation(fields: [propertyId], references: [id])
  agency    Agency?    @relation(fields: [agencyId], references: [id])
  tenant    User?      @relation("InvoiceTenant", fields: [tenantId], references: [id])
  owner     User?      @relation("InvoiceOwner", fields: [ownerId], references: [id])
  creator   User?      @relation("InvoiceCreator", fields: [createdBy], references: [id])
  transfers Transfer[]

  @@index([contractId])
  @@index([propertyId])
  @@index([agencyId])
  @@index([tenantId])
  @@index([status])
  @@index([dueDate])
  @@index([referenceMonth])
  @@map("invoices")
}

model Transfer {
  id               BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  invoiceId        BigInt   @map("invoice_id") @db.UnsignedBigInt
  date             DateTime @db.Date
  grossValue       Decimal  @map("gross_value") @db.Decimal(12, 2)
  mr3xFee          Decimal  @map("mr3x_fee") @db.Decimal(12, 2)
  pspFee           Decimal  @map("psp_fee") @db.Decimal(12, 2)
  retainedTax      Decimal  @map("retained_tax") @db.Decimal(12, 2)
  transferredValue Decimal  @map("transferred_value") @db.Decimal(12, 2)
  recipientId      BigInt   @map("recipient_id") @db.UnsignedBigInt
  status           String   @db.VarChar(20)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  invoice   Invoice @relation(fields: [invoiceId], references: [id])
  recipient User    @relation(fields: [recipientId], references: [id])

  @@map("transfers")
}

model PlatformSettings {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  key         String   @unique @db.VarChar(100)
  value       String   @db.Text
  description String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  @@map("platform_settings")
}

model Expense {
  id            BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  propertyId    BigInt   @map("property_id") @db.UnsignedBigInt
  type          String   @db.VarChar(50) // tax, condo, water, electricity, gas, renovation
  value         Decimal  @db.Decimal(12, 2)
  dueDate       DateTime @map("due_date") @db.Date
  payer         String   @db.VarChar(20) // owner/tenant/agency
  invoiceUrl    String?  @map("invoice_url") @db.VarChar(500)
  proof         String?  @db.VarChar(500)
  applyDiscount Boolean  @default(false) @map("apply_discount")
  applyToRent   Boolean  @default(false) @map("apply_to_rent")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  property Property @relation(fields: [propertyId], references: [id])

  @@map("expenses")
}

model Inspection {
  id           BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  propertyId   BigInt   @map("property_id") @db.UnsignedBigInt
  contractId   BigInt?  @map("contract_id") @db.UnsignedBigInt
  agencyId     BigInt?  @map("agency_id") @db.UnsignedBigInt
  type         String   @db.VarChar(20) // ENTRY/EXIT/PERIODIC
  date         DateTime @db.Date
  scheduledDate DateTime? @map("scheduled_date") @db.Date
  inspectorId  BigInt   @map("inspector_id") @db.UnsignedBigInt
  assignedById BigInt?  @map("assigned_by_id") @db.UnsignedBigInt

  // Inspection content
  rooms        String?  @db.Text // JSON array of rooms with items
  photos       String?  @db.Text // JSON array of photo URLs with metadata
  notes        String?  @db.Text // General inspection notes

  // Signatures
  tenantSignature    String?   @map("tenant_signature") @db.Text // Base64 signature
  tenantSignedAt     DateTime? @map("tenant_signed_at") @db.Timestamp(0)
  ownerSignature     String?   @map("owner_signature") @db.Text
  ownerSignedAt      DateTime? @map("owner_signed_at") @db.Timestamp(0)
  agencySignature    String?   @map("agency_signature") @db.Text
  agencySignedAt     DateTime? @map("agency_signed_at") @db.Timestamp(0)
  inspectorSignature String?   @map("inspector_signature") @db.Text
  inspectorSignedAt  DateTime? @map("inspector_signed_at") @db.Timestamp(0)

  // Report
  pdfReportUrl String?  @map("pdf_report_url") @db.VarChar(500)
  reportGeneratedAt DateTime? @map("report_generated_at") @db.Timestamp(0)

  // Status and approval
  status       String   @default("RASCUNHO") @db.VarChar(20) // RASCUNHO/EM_ANDAMENTO/AGUARDANDO_ASSINATURA/CONCLUIDA/APROVADA/REJEITADA
  approvedById BigInt?  @map("approved_by_id") @db.UnsignedBigInt
  approvedAt   DateTime? @map("approved_at") @db.Timestamp(0)
  rejectionReason String? @map("rejection_reason") @db.Text

  // Template reference
  templateId   BigInt?  @map("template_id") @db.UnsignedBigInt

  // Metadata
  location     String?  @db.VarChar(255) // GPS coordinates or address
  createdBy    BigInt?  @map("created_by") @db.UnsignedBigInt
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  // Relations
  property  Property @relation(fields: [propertyId], references: [id])
  inspector User     @relation("InspectionInspector", fields: [inspectorId], references: [id])
  assignedBy User?   @relation("InspectionAssignedBy", fields: [assignedById], references: [id])
  approvedBy User?   @relation("InspectionApprovedBy", fields: [approvedById], references: [id])
  createdByUser User? @relation("InspectionCreatedBy", fields: [createdBy], references: [id])
  template  InspectionTemplate? @relation(fields: [templateId], references: [id])
  items     InspectionItem[]

  @@map("inspections")
}

model InspectionTemplate {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  name        String   @db.VarChar(255)
  description String?  @db.Text
  type        String   @db.VarChar(20) // ENTRY/EXIT/PERIODIC
  rooms       String   @db.Text // JSON array of room templates with items
  agencyId    BigInt?  @map("agency_id") @db.UnsignedBigInt
  createdBy   BigInt   @map("created_by") @db.UnsignedBigInt
  isDefault   Boolean  @default(false) @map("is_default")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  inspections Inspection[]

  @@map("inspection_templates")
}

model InspectionItem {
  id           BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  inspectionId BigInt   @map("inspection_id") @db.UnsignedBigInt
  room         String   @db.VarChar(100) // Room name (Sala, Quarto, Cozinha, etc.)
  item         String   @db.VarChar(255) // Item name (Parede, Piso, Janela, etc.)
  condition    String   @db.VarChar(20) // OK/DANIFICADO/AUSENTE/REPARAR
  description  String?  @db.Text
  photos       String?  @db.Text // JSON array of photo URLs for this item
  needsRepair  Boolean  @default(false) @map("needs_repair")
  repairCost   Decimal? @map("repair_cost") @db.Decimal(12, 2)
  responsible  String?  @db.VarChar(20) // INQUILINO/PROPRIETARIO/AGENCIA
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@map("inspection_items")
}

model AuditLog {
  id         BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  event      String   @db.VarChar(100)
  userId     BigInt?  @map("user_id") @db.UnsignedBigInt
  entity     String   @db.VarChar(50)
  entityId   BigInt   @map("entity_id") @db.UnsignedBigInt
  timestamp  DateTime @default(now()) @db.Timestamp(0)
  dataBefore String?  @map("data_before") @db.Text
  dataAfter  String?  @map("data_after") @db.Text
  ip         String?  @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.VarChar(500)

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

model PropertyImage {
  id           BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  propertyId   BigInt   @map("property_id") @db.UnsignedBigInt
  filename     String   @db.VarChar(255)
  originalName String   @map("original_name") @db.VarChar(255)
  mimeType     String   @map("mime_type") @db.VarChar(100)
  size         Int      @db.UnsignedInt
  path         String   @db.VarChar(500)
  isPrimary    Boolean  @default(false) @map("is_primary")
  uploadedAt   DateTime @default(now()) @map("uploaded_at") @db.Timestamp(0)
  uploadedBy   BigInt   @map("uploaded_by") @db.UnsignedBigInt

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  uploader User     @relation("PropertyImageUploader", fields: [uploadedBy], references: [id])

  @@map("property_images")
}

/// Agreements (Acordos/Termos) - Negotiated documents between parties during rental lifecycle
model Agreement {
  id           BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  contractId   BigInt?  @map("contract_id") @db.UnsignedBigInt
  propertyId   BigInt   @map("property_id") @db.UnsignedBigInt
  agencyId     BigInt?  @map("agency_id") @db.UnsignedBigInt

  // Agreement type and details
  type         String   @db.VarChar(50) // PAYMENT_SETTLEMENT, DAMAGE_COMPENSATION, FINE_AGREEMENT, MOVE_OUT, CONTRACT_ADJUSTMENT, OTHER
  title        String   @db.VarChar(255)
  description  String?  @db.Text
  content      String?  @db.Text // Full agreement text/terms
  templateId   String?  @map("template_id") @db.VarChar(100) // Template identifier

  // Parties involved
  tenantId     BigInt?  @map("tenant_id") @db.UnsignedBigInt
  ownerId      BigInt?  @map("owner_id") @db.UnsignedBigInt

  // Financial terms (for payment/settlement agreements)
  originalAmount    Decimal? @map("original_amount") @db.Decimal(12, 2)
  negotiatedAmount  Decimal? @map("negotiated_amount") @db.Decimal(12, 2)
  fineAmount        Decimal? @map("fine_amount") @db.Decimal(12, 2)
  discountAmount    Decimal? @map("discount_amount") @db.Decimal(12, 2)
  installments      Int?     @map("installments") // Number of installments
  installmentValue  Decimal? @map("installment_value") @db.Decimal(12, 2)

  // Dates
  effectiveDate    DateTime? @map("effective_date") @db.Date // When agreement takes effect
  expirationDate   DateTime? @map("expiration_date") @db.Date // Agreement validity end
  newDueDate       DateTime? @map("new_due_date") @db.Date // New payment due date
  moveOutDate      DateTime? @map("move_out_date") @db.Date // For move-out agreements

  // Signatures
  tenantSignature    String?   @map("tenant_signature") @db.Text // Base64 signature
  tenantSignedAt     DateTime? @map("tenant_signed_at") @db.Timestamp(0)
  ownerSignature     String?   @map("owner_signature") @db.Text
  ownerSignedAt      DateTime? @map("owner_signed_at") @db.Timestamp(0)
  agencySignature    String?   @map("agency_signature") @db.Text
  agencySignedAt     DateTime? @map("agency_signed_at") @db.Timestamp(0)

  // Status and workflow
  status       String   @default("RASCUNHO") @db.VarChar(30) // RASCUNHO/AGUARDANDO_ASSINATURA/ASSINADO/CONCLUIDO/REJEITADO/CANCELADO

  // Approval
  approvedById BigInt?  @map("approved_by_id") @db.UnsignedBigInt
  approvedAt   DateTime? @map("approved_at") @db.Timestamp(0)
  rejectionReason String? @map("rejection_reason") @db.Text

  // Payment integration (Asaas)
  asaasPaymentId   String?   @map("asaas_payment_id") @db.VarChar(100)
  asaasPaymentLink String?   @map("asaas_payment_link") @db.VarChar(500)
  paymentStatus    String?   @map("payment_status") @db.VarChar(30)

  // Attachments and documents
  attachments  String?  @db.Text // JSON array of attachment URLs
  pdfUrl       String?  @map("pdf_url") @db.VarChar(500)

  // Token for verification
  agreementToken String? @unique @map("agreement_token") @db.VarChar(100) // MR3X-AGR-2025-XXXXX format
  agreementHash  String? @map("agreement_hash") @db.VarChar(255) // SHA-256 hash

  // Client info for audit
  clientIP     String?  @map("client_ip") @db.VarChar(45)
  userAgent    String?  @map("user_agent") @db.VarChar(500)

  // Metadata
  notes        String?  @db.Text // Internal notes
  createdBy    BigInt   @map("created_by") @db.UnsignedBigInt
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  // Relations
  contract     Contract? @relation(fields: [contractId], references: [id])
  property     Property  @relation(fields: [propertyId], references: [id])
  tenant       User?     @relation("AgreementTenant", fields: [tenantId], references: [id])
  owner        User?     @relation("AgreementOwner", fields: [ownerId], references: [id])
  approvedBy   User?     @relation("AgreementApprovedBy", fields: [approvedById], references: [id])
  createdByUser User     @relation("AgreementCreatedBy", fields: [createdBy], references: [id])

  @@map("agreements")
}

/// Agreement templates for quick creation
model AgreementTemplate {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  name        String   @db.VarChar(255)
  description String?  @db.Text
  type        String   @db.VarChar(50) // PAYMENT_SETTLEMENT, DAMAGE_COMPENSATION, FINE_AGREEMENT, MOVE_OUT, CONTRACT_ADJUSTMENT, OTHER
  content     String   @db.Text // Template content with placeholders
  agencyId    BigInt?  @map("agency_id") @db.UnsignedBigInt
  createdBy   BigInt   @map("created_by") @db.UnsignedBigInt
  isDefault   Boolean  @default(false) @map("is_default")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  @@map("agreement_templates")
}

/// Sales Representative Inbox Messages
model SalesMessage {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  senderId    BigInt   @map("sender_id") @db.UnsignedBigInt
  recipientId BigInt   @map("recipient_id") @db.UnsignedBigInt
  subject     String   @db.VarChar(255)
  content     String   @db.Text
  isRead      Boolean  @default(false) @map("is_read")
  isStarred   Boolean  @default(false) @map("is_starred")
  isDeleted   Boolean  @default(false) @map("is_deleted")
  readAt      DateTime? @map("read_at") @db.Timestamp(0)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  // Relations
  sender    User @relation("SalesMessageSender", fields: [senderId], references: [id])
  recipient User @relation("SalesMessageRecipient", fields: [recipientId], references: [id])
  replies   SalesMessageReply[]

  @@index([recipientId])
  @@index([senderId])
  @@map("sales_messages")
}

/// Sales Message Replies (conversation thread)
model SalesMessageReply {
  id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  messageId BigInt   @map("message_id") @db.UnsignedBigInt
  senderId  BigInt   @map("sender_id") @db.UnsignedBigInt
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  message SalesMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  sender  User         @relation("SalesMessageReplySender", fields: [senderId], references: [id])

  @@index([messageId])
  @@map("sales_message_replies")
}

/// Sales Representative Notifications
model SalesNotification {
  id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId    BigInt   @map("user_id") @db.UnsignedBigInt
  type      String   @db.VarChar(50) // lead, proposal, commission, system
  title     String   @db.VarChar(255)
  message   String   @db.Text
  link      String?  @db.VarChar(255)
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  user User @relation("SalesNotificationUser", fields: [userId], references: [id])

  @@index([userId])
  @@map("sales_notifications")
}

/// Sales Representative Prospects (potential clients)
model SalesProspect {
  id              BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  salesRepId      BigInt   @map("sales_rep_id") @db.UnsignedBigInt
  name            String   @db.VarChar(255)
  contactName     String   @map("contact_name") @db.VarChar(255)
  contactEmail    String   @map("contact_email") @db.VarChar(191)
  contactPhone    String?  @map("contact_phone") @db.VarChar(30)
  address         String?  @db.VarChar(255)
  city            String?  @db.VarChar(100)
  state           String?  @db.VarChar(10)
  cnpj            String?  @db.VarChar(20)
  status          String   @default("prospecting") @db.VarChar(30) // prospecting, qualification, proposal_sent, negotiation, closed_won, closed_lost
  stage           String   @default("prospecting") @db.VarChar(30) // Same as status, for pipeline visualization
  source          String?  @db.VarChar(50) // Indicação, Site, LinkedIn, Eventos, Cold Call
  estimatedValue  Decimal? @map("estimated_value") @db.Decimal(12, 2)
  probability     Int?     @default(20) // 0-100
  notes           String?  @db.Text
  lastContactAt   DateTime? @map("last_contact_at") @db.Timestamp(0)
  nextAction      String?  @map("next_action") @db.VarChar(255)
  nextActionDate  DateTime? @map("next_action_date") @db.Date
  convertedAt     DateTime? @map("converted_at") @db.Timestamp(0)
  lostAt          DateTime? @map("lost_at") @db.Timestamp(0)
  lostReason      String?  @map("lost_reason") @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  // Relations
  salesRep  User            @relation("SalesRepProspects", fields: [salesRepId], references: [id])
  proposals SalesProposal[]
  activities SalesActivity[]

  @@index([salesRepId])
  @@index([status])
  @@map("sales_prospects")
}

/// Sales Representative Proposals
model SalesProposal {
  id              BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  salesRepId      BigInt   @map("sales_rep_id") @db.UnsignedBigInt
  prospectId      BigInt   @map("prospect_id") @db.UnsignedBigInt
  title           String   @db.VarChar(255)
  planType        String   @map("plan_type") @db.VarChar(50) // starter, business, premium, enterprise
  value           Decimal  @db.Decimal(12, 2)
  discount        Decimal? @default(0) @db.Decimal(5, 2) // percentage
  finalValue      Decimal  @map("final_value") @db.Decimal(12, 2)
  status          String   @default("draft") @db.VarChar(30) // draft, sent, viewed, accepted, rejected, expired
  validUntil      DateTime @map("valid_until") @db.Date
  sentAt          DateTime? @map("sent_at") @db.Timestamp(0)
  viewedAt        DateTime? @map("viewed_at") @db.Timestamp(0)
  respondedAt     DateTime? @map("responded_at") @db.Timestamp(0)
  notes           String?  @db.Text
  items           String?  @db.Text // JSON array of items
  pdfUrl          String?  @map("pdf_url") @db.VarChar(500)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  // Relations
  salesRep   User          @relation("SalesRepProposals", fields: [salesRepId], references: [id])
  prospect   SalesProspect @relation(fields: [prospectId], references: [id])
  commission SalesCommission?

  @@index([salesRepId])
  @@index([prospectId])
  @@index([status])
  @@map("sales_proposals")
}

/// Sales Representative Commissions
model SalesCommission {
  id              BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  salesRepId      BigInt   @map("sales_rep_id") @db.UnsignedBigInt
  proposalId      BigInt?  @unique @map("proposal_id") @db.UnsignedBigInt
  agencyId        BigInt?  @map("agency_id") @db.UnsignedBigInt
  agencyName      String   @map("agency_name") @db.VarChar(255)
  planType        String   @map("plan_type") @db.VarChar(50)
  dealValue       Decimal  @map("deal_value") @db.Decimal(12, 2)
  commissionRate  Decimal  @map("commission_rate") @db.Decimal(5, 2) // percentage
  commissionValue Decimal  @map("commission_value") @db.Decimal(12, 2)
  status          String   @default("pending") @db.VarChar(30) // pending, processing, paid
  closedAt        DateTime @map("closed_at") @db.Timestamp(0)
  paidAt          DateTime? @map("paid_at") @db.Timestamp(0)
  paymentMonth    String?  @map("payment_month") @db.VarChar(7) // YYYY-MM
  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  // Relations
  salesRep  User           @relation("SalesRepCommissions", fields: [salesRepId], references: [id])
  proposal  SalesProposal? @relation(fields: [proposalId], references: [id])

  @@index([salesRepId])
  @@index([status])
  @@index([paymentMonth])
  @@map("sales_commissions")
}

/// Sales Representative Activities (for tracking interactions)
model SalesActivity {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  salesRepId  BigInt   @map("sales_rep_id") @db.UnsignedBigInt
  prospectId  BigInt?  @map("prospect_id") @db.UnsignedBigInt
  type        String   @db.VarChar(50) // call, meeting, email, proposal, follow_up, note
  title       String   @db.VarChar(255)
  description String?  @db.Text
  date        DateTime @db.Timestamp(0)
  duration    Int?     // minutes
  outcome     String?  @db.VarChar(100) // positive, neutral, negative
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  salesRep User           @relation("SalesRepActivities", fields: [salesRepId], references: [id])
  prospect SalesProspect? @relation(fields: [prospectId], references: [id])

  @@index([salesRepId])
  @@index([prospectId])
  @@index([date])
  @@map("sales_activities")
}

/// Sales Representative Goals/Targets
model SalesGoal {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  salesRepId  BigInt   @map("sales_rep_id") @db.UnsignedBigInt
  month       String   @db.VarChar(7) // YYYY-MM
  targetLeads Int      @default(0) @map("target_leads")
  targetConversions Int @default(0) @map("target_conversions")
  targetRevenue Decimal @default(0) @map("target_revenue") @db.Decimal(12, 2)
  achievedLeads Int    @default(0) @map("achieved_leads")
  achievedConversions Int @default(0) @map("achieved_conversions")
  achievedRevenue Decimal @default(0) @map("achieved_revenue") @db.Decimal(12, 2)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  // Relations
  salesRep User @relation("SalesRepGoals", fields: [salesRepId], references: [id])

  @@unique([salesRepId, month])
  @@index([salesRepId])
  @@map("sales_goals")
}

/// Plan modification requests from ADMIN users that require CEO approval
model PlanModificationRequest {
  id              BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  planName        String   @map("plan_name") @db.VarChar(50)
  requestedById   BigInt   @map("requested_by_id") @db.UnsignedBigInt
  status          String   @default("PENDING") @db.VarChar(20) // PENDING, APPROVED, REJECTED

  // Current values (before modification)
  currentPrice         Decimal?  @map("current_price") @db.Decimal(12, 2)
  currentPropertyLimit Int?      @map("current_property_limit")
  currentUserLimit     Int?      @map("current_user_limit")
  currentFeatures      String?   @map("current_features") @db.Text
  currentDescription   String?   @map("current_description") @db.VarChar(255)

  // Requested values (after modification)
  requestedPrice         Decimal?  @map("requested_price") @db.Decimal(12, 2)
  requestedPropertyLimit Int?      @map("requested_property_limit")
  requestedUserLimit     Int?      @map("requested_user_limit")
  requestedFeatures      String?   @map("requested_features") @db.Text
  requestedDescription   String?   @map("requested_description") @db.VarChar(255)

  // Approval info
  reviewedById    BigInt?   @map("reviewed_by_id") @db.UnsignedBigInt
  reviewedAt      DateTime? @map("reviewed_at") @db.Timestamp(0)
  rejectionReason String?   @map("rejection_reason") @db.Text

  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  requestedBy User  @relation("PlanModificationRequester", fields: [requestedById], references: [id])
  reviewedBy  User? @relation("PlanModificationReviewer", fields: [reviewedById], references: [id])

  @@map("plan_modification_requests")
}

/// Tenant Analysis - Complete screening for prospective tenants
enum TenantAnalysisStatus {
  PENDING
  COMPLETED
  FAILED
  EXPIRED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model TenantAnalysis {
  id              BigInt   @id @default(autoincrement()) @db.UnsignedBigInt

  // Document info
  document        String   @db.VarChar(20) // CPF or CNPJ
  documentType    String   @map("document_type") @db.VarChar(10) // CPF or CNPJ
  name            String?  @db.VarChar(255) // Name from lookup

  // Who requested
  requestedById   BigInt   @map("requested_by_id") @db.UnsignedBigInt
  agencyId        BigInt?  @map("agency_id") @db.UnsignedBigInt

  // Financial Analysis
  creditScore           Int?     @map("credit_score")
  totalDebts            Decimal? @map("total_debts") @db.Decimal(12, 2)
  activeDebts           Int?     @map("active_debts")
  hasNegativeRecords    Boolean? @map("has_negative_records")
  paymentDelays         Int?     @map("payment_delays") // Total payment delays
  averageDelayDays      Int?     @map("average_delay_days")
  financialDetails      String?  @map("financial_details") @db.Text // JSON with debt details
  financialStatus       String?  @map("financial_status") @db.VarChar(20) // CLEAR, WARNING, CRITICAL

  // Criminal Background
  hasCriminalRecords    Boolean? @map("has_criminal_records")
  criminalRecordsCount  Int?     @map("criminal_records_count")
  criminalDetails       String?  @map("criminal_details") @db.Text // JSON with record details
  criminalStatus        String?  @map("criminal_status") @db.VarChar(20)

  // Judicial Check
  hasJudicialRecords    Boolean? @map("has_judicial_records")
  judicialRecordsCount  Int?     @map("judicial_records_count")
  hasEvictions          Boolean? @map("has_evictions")
  evictionsCount        Int?     @map("evictions_count")
  judicialDetails       String?  @map("judicial_details") @db.Text // JSON with lawsuit details
  judicialStatus        String?  @map("judicial_status") @db.VarChar(20)

  // Protest Records
  hasProtests           Boolean? @map("has_protests")
  protestsCount         Int?     @map("protests_count")
  totalProtestValue     Decimal? @map("total_protest_value") @db.Decimal(12, 2)
  protestDetails        String?  @map("protest_details") @db.Text // JSON
  protestStatus         String?  @map("protest_status") @db.VarChar(20)

  // Document Validation
  documentValid         Boolean? @map("document_valid")
  documentActive        Boolean? @map("document_active")
  documentOwnerMatch    Boolean? @map("document_owner_match")
  hasFraudAlerts        Boolean? @map("has_fraud_alerts")
  documentStatus        String?  @map("document_status") @db.VarChar(20)

  // Overall Risk Assessment
  riskScore             Int?     @map("risk_score") // 0-1000
  riskLevel             RiskLevel? @map("risk_level")
  recommendation        String?  @db.VarChar(50) // APPROVED, APPROVED_WITH_CAUTION, REQUIRES_GUARANTOR, REJECTED
  recommendationNotes   String?  @map("recommendation_notes") @db.Text

  // Raw API response (for auditing)
  rawResponse           String?  @map("raw_response") @db.LongText

  // Status
  status                TenantAnalysisStatus @default(PENDING)
  errorMessage          String?  @map("error_message") @db.VarChar(500)

  // Validity
  validUntil            DateTime? @map("valid_until") @db.Timestamp(0) // Analysis expiration

  // Timestamps
  analyzedAt            DateTime? @map("analyzed_at") @db.Timestamp(0)
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt             DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  // Relations
  requestedBy   User    @relation("TenantAnalysisRequestedBy", fields: [requestedById], references: [id])

  @@index([document])
  @@index([requestedById])
  @@index([agencyId])
  @@index([status])
  @@index([riskLevel])
  @@map("tenant_analyses")
}
